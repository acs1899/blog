<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
		
      <title>zabbix与外部监控脚本整合方案 &bull; Louis-Sherren</title>
		
    <link rel="stylesheet" href="/stylesheets/screen.css" type="text/css" media="all" />
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="all" />
    <link rel="alternate" title="louis-sherren" type="application/atom+xml" href="/atom.xml" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
		<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css' /> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="Viewport" content="maximum-scale=1.8,width=720" />
    
  </head>
 
  <body>
	
    <div id="header">
    	<h1>
    		<a href="/" title="louis-sherren">louis sherren</a>
    	</h1>
    </div>
    <div class="clear_both"></div>
    <div id="navigation">
    	<ul>
    		<li><a href="/about/" title="About this Blog">About</a></li>
    		<li><a href="/archive/" title="Archive of this Blog">Archive</a>&bull;</li> 
            <li id="c_popup"><a href="javascript:void" title="Category">Category</a>&bull;</li>
    		<li><a href="/" title="Blog">Blog</a>&bull;</li> 
    	</ul>
        <div class="category_popup">
            <div class="category_popup_main">
                <div class="category_item" data-href="/categories/linux/">Linux</div>
                <div class="category_item" data-href="/categories/php/">PHP</div>
                <div class="category_item" data-href="/categories/shell/">Shell</div>
                <div class="category_item" data-href="/categories/gist/">Gist</div>
                <div class="category_item" data-href="/categories/javascript/">JavaScript</div>
                <div class="category_item" data-href="/categories/c/">C</div>
                <div class="category_item" data-href="/categories/python/">Python</div>
                <div class="category_item" data-href="/categories/apache/">Apache</div>
                <div class="clear_both"></div>
            </div>
        </div>
    </div>			
    <div class="clear_both"></div>
		<h2>
	<a href="/2013/10/zabbix-works-with-external-scripts/" title="[Permalink] zabbix与外部监控脚本整合方案">zabbix与外部监控脚本整合方案</a>
</h2>
<div class="post_date">16 October 2013</div>

<blockquote>
<p>自写的外部监控脚本可能需要单独处理报警触发条件，结果展现等问题。而触发条件可能遇到很复杂的情况，zabbix对于这类问题是一个很不错的方案，而且zabbix完全支持外部数据处理。本文介绍一个将zabbix和外部监控脚本整合的方案。</p>
</blockquote>

<hr>

<h3>场景例子</h3>

<p>UrlWatch是一个python脚本，监控部分url的状态，包括：</p>

<ul>
<li>code 返回代码</li>
<li>span 执行时间</li>
</ul>

<p>现在的需求是用zabbix来搜集code和span数据，然后决策是否发出报警，画统计图。</p>

<h3>实现</h3>

<h4>整体思路</h4>

<p>外部脚本在一个 <strong><em>source</em></strong> 文件上打日志，日志格式是：</p>

<blockquote>
<p>service  item[params]=value  item[params]=value ...</p>
</blockquote>

<p>service是服务，item是监控项，params是额外的参数，value是对应值</p>

<p>对应到UrlWatch的例子：</p>

<div class="highlight"><pre><code class="python"><span class="n">urlwatch</span>  <span class="n">code</span><span class="p">[</span><span class="n">www</span><span class="o">.</span><span class="n">baidu</span><span class="o">.</span><span class="n">com</span><span class="p">]</span><span class="o">=</span><span class="mi">200</span>   <span class="n">span</span><span class="p">[</span><span class="n">www</span><span class="o">.</span><span class="n">baidu</span><span class="o">.</span><span class="n">com</span><span class="p">]</span><span class="o">=</span><span class="mf">0.001</span>
<span class="n">urlwatch</span>  <span class="n">code</span><span class="p">[</span><span class="n">www</span><span class="o">.</span><span class="n">sina</span><span class="o">.</span><span class="n">com</span><span class="p">]</span><span class="o">=</span><span class="mi">302</span>    <span class="n">span</span><span class="p">[</span><span class="n">www</span><span class="o">.</span><span class="n">sina</span><span class="o">.</span><span class="n">com</span><span class="p">]</span><span class="o">=</span><span class="mf">0.00001</span>
</code></pre>
</div>

<p>然后一个pnp(pull n push)守护程序去监控这个 <strong><em>source</em></strong> 文件的新添加的内容（类似tail -F），
一旦检测到新内容后，读取并进行PARSE，然后与一个 <strong><em>discovery</em></strong> 文件内容做对比，
<strong><em>discovery</em></strong> 文件保存的是discovery需要使用的JSON格式数据（见后文），如果service和item组合
不存在于discovery文件中，则以固定格式写进discovery文件。 之后调用zabbix_sender将结果发送给
server端，实现zabbix搜集数据。
server端的discovery跑一个自定义的key（后文），key对应的程序拉取discovery文件的JSON数据稍微组合后返回给zabbix，实现基于source中的
service和item自动创建zabbix的item、trigger、graph等。
实现结构大致如下图：
<img src="/images/post/zabbix-workds-with-external-script/4.png" alt="arch"></p>

<h4>discovery</h4>

<p>在zabbix前端建立名为 <strong><em>external</em></strong> 的host，该host管理外部数据。
在host建立一个discovery。
<img src="/images/post/zabbix-workds-with-external-script/1.jpg" alt="discovery"></p>

<p>这里说明一下key，discovery支持自定义的发现，也就是可以用UserParameter来设定discovery的自定义key，自定义key返回固定格式的json数据，如下：
<img src="/images/post/zabbix-workds-with-external-script/2.jpg" alt="discovery json">
当data中每多一项，则discovery就认为多发现了一项。</p>

<p>还要注意这里key中还指定了参数，这两个参数是过滤data数组用的，也就是说从一个json数据中赛选出部分数据返回，不返回全部. Discovery本身也支持过滤，filter，可以指定macro来只返回我们关心的数据，不过经过测试只能支持单一的macro匹配。</p>

<p>在上面这个例子，我们可以通过FSNAME来过滤内容（只返回FSNAME字段的内容匹配的项），但不能通过FSNAME 和 FSTYPE来过滤（实验结果，官方文档没做介绍），所以这里改用参数来进行过滤。由于返回数据是由自定义key来做，所以我们可以随意得根据参数来过滤内容（这部分不熟悉的可以参考zabbix UserParameter）。</p>

<p>然后我们需要做的就是自写一个脚本作为external.discovery的执行脚本，并支持传入参数。返回的数据格式符合标准就OK。</p>

<h4>item prototype</h4>

<p>接下来的工作就是创建item prototype，一旦discovery发现新项，就会自动根据item样板创建实际的item，如果一个discovery下有多个item prototype，那么每发现一个新项（data数组中多一个元素），discovery就会创建多个item。trigger类似。
<img src="/images/post/zabbix-workds-with-external-script/3.jpg" alt="item prototype">
呃，这里注意macro的使用就行了，我把所有的外部脚本的key都明明为external，从参数去区分他们。
item设置里可以使用descovery返回数据中的macro（就是data数组中每个元素的键名，注意这里宏的符号是#），type必须选择Zabbix trapper，因为要用到zabbix sender主动推送数据过来。</p>

<p>zabbix前端暂时就这样。</p>

<h4>script</h4>

<p>点<a href="https://github.com/louis-sherren/l2zabbix">这里</a>查看代码</p>


<div class="previous_next_post">

  
    <p>
      <strong>Previous Entry:</strong>
      <a href="/2013/10/nice-things-happen/" title="杂谈">杂谈</a>
    </p>
  

  
    <p>
      <strong>Next Entry:</strong>
      <a href="/2013/11/build-git-server/" title="如何搭建一个自动部署的git server">如何搭建一个自动部署的git server</a>
    </p>
  
  
  <div style="clear: both;"></div>
  
</div>


		
    <div id="footer">
      Powered by <a href="http://github.com/mojombo/jekyll" title="Jekyll Site Generator">Jekyll</a> 

    </div>
    <script src="/scripts/jquery.js"></script>
    <script>
        var c_popup = $("#c_popup");
        var category_popup = $(".category_popup");
        var category_items = $(".category_item");
        c_popup.mouseover(function(){
            category_popup.show();
        });
        c_popup.mouseout(function(){
            category_popup.hide();
        });
        category_popup.mouseover(function(){
            category_popup.show();
        })
        category_popup.mouseout(function(){
            category_popup.hide();
        });
        $(".category_item").click(function(){
            location.href = $(this).attr("data-href");
        });
    </script>
  </body>
</html>
