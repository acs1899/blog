<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
		
      <title>如何搭建一个自动部署的git server &bull; Louis-Sherren</title>
		
    <link rel="stylesheet" href="/stylesheets/screen.css" type="text/css" media="all" />
    <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="all" />
    <link rel="alternate" title="louis-sherren" type="application/atom+xml" href="/atom.xml" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
		<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css' /> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="Viewport" content="maximum-scale=1.8,width=720" />
    
  </head>
 
  <body>
	
    <div id="header">
    	<h1>
    		<a href="/" title="louis-sherren">louis sherren</a>
    	</h1>
    </div>
    <div class="clear_both"></div>
    <div id="navigation">
    	<ul>
    		<li><a href="/about/" title="About this Blog">About</a></li>
    		<li><a href="/archive/" title="Archive of this Blog">Archive</a>&bull;</li> 
            <li id="c_popup"><a href="javascript:void" title="Category">Category</a>&bull;</li>
    		<li><a href="/" title="Blog">Blog</a>&bull;</li> 
    	</ul>
        <div class="category_popup">
            <div class="category_popup_main">
                <div class="category_item" data-href="/categories/linux/">Linux</div>
                <div class="category_item" data-href="/categories/php/">PHP</div>
                <div class="category_item" data-href="/categories/shell/">Shell</div>
                <div class="category_item" data-href="/categories/gist/">Gist</div>
                <div class="category_item" data-href="/categories/javascript/">JavaScript</div>
                <div class="category_item" data-href="/categories/c/">C</div>
                <div class="category_item" data-href="/categories/python/">Python</div>
                <div class="category_item" data-href="/categories/apache/">Apache</div>
                <div class="clear_both"></div>
            </div>
        </div>
    </div>			
    <div class="clear_both"></div>
		<h2>
	<a href="/2013/11/build-git-server/" title="[Permalink] 如何搭建一个自动部署的git server">如何搭建一个自动部署的git server</a>
</h2>
<div class="post_date">12 November 2013</div>

<blockquote>
<p>该文介绍如何在centos下用gitosis搭建一个带自动部署功能的git server</p>
</blockquote>

<hr>

<h3>安装</h3>

<ul>
<li>git </li>
</ul>

<div class="highlight"><pre><code class="ruby"><span class="n">yum</span> <span class="n">install</span> <span class="n">git</span><span class="o">-</span><span class="n">core</span>
</code></pre>
</div>

<ul>
<li>python setup tools</li>
</ul>

<div class="highlight"><pre><code class="ruby"><span class="n">yum</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">setuptools</span>
</code></pre>
</div>

<ul>
<li>gitosis</li>
</ul>

<div class="highlight"><pre><code class="ruby"><span class="n">git</span> <span class="nb">clone</span> <span class="ss">https</span><span class="p">:</span><span class="sr">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">res0nat0r</span><span class="o">/</span><span class="n">gitosis</span><span class="o">.</span><span class="n">git</span> 
<span class="n">cd</span> <span class="n">gitosis</span>
<span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>  
 
</code></pre>
</div>

<h3>配置</h3>

<ul>
<li>首先建立一个git用户，专门用来管理git仓库</li>
</ul>

<div class="highlight"><pre><code class="ruby"><span class="n">useradd</span> <span class="o">-</span><span class="n">m</span> <span class="n">git</span>
</code></pre>
</div>

<ul>
<li>准备一份公钥（ssh public key）</li>
</ul>

<p>gitosis的初始化需要一份公钥，对应用户即为git repo的管理员。这里管理员对git repo的控制，实际上也是通过控制一个gitosis-admin.git来控制成员和其他repo的，admin-repo中有一份配置文档和一个keydir，keydir里面存放成员的公钥，后面会cover这一点。</p>

<p>现在处于方便，直接将本机用root账户作为repo的管理员，切到root下</p>

<div class="highlight"><pre><code class="ruby"><span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span>
<span class="c1"># 三次回车</span>
<span class="n">ls</span> <span class="o">~</span><span class="sr">/.ssh/i</span><span class="n">d_rsa</span><span class="o">.</span><span class="n">pub</span>
</code></pre>
</div>

<p>公钥生成了，即~/.ssh/id_rsa.pub</p>

<ul>
<li>初始化gitosis</li>
</ul>

<p>需要先切到git用户下再进行初始化</p>

<div class="highlight"><pre><code class="ruby"><span class="n">su</span> <span class="o">-</span> <span class="n">git</span>
<span class="n">gitosis</span><span class="o">-</span><span class="n">init</span> <span class="o">&lt;</span> <span class="o">~</span><span class="sr">/.ssh/i</span><span class="n">d_rsa</span><span class="o">.</span><span class="n">pub</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">755</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">repositories</span><span class="o">/</span><span class="n">gitosis</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="n">git</span><span class="o">/</span><span class="n">hooks</span><span class="o">/</span><span class="n">post</span><span class="o">-</span><span class="n">update</span>
</code></pre>
</div>

<p>这样在git的HOME文件夹中会出现repositories目录，即仓库目录，目录中有一个gitosis-admin.git目录，即上文提到的。
现在本机root账户拥有这个仓库的读写权限。</p>

<p>这里最后一行权限修改很重要，如果不修改则配置不会生效。</p>

<ul>
<li>增加成员和仓库</li>
</ul>

<p>用本机root身份将gitosis-admin.git pull下来</p>

<div class="highlight"><pre><code class="ruby"><span class="n">git</span> <span class="n">init</span>
<span class="n">git</span> <span class="n">remote</span> <span class="n">add</span> <span class="n">origin</span> <span class="n">git</span><span class="vi">@hostname_or_ipaddr</span><span class="ss">:/</span><span class="n">gitosis</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="n">git</span>
<span class="c1"># 注意这里只有一个 : 和一个 / </span>
<span class="n">git</span> <span class="n">pull</span> <span class="n">origin</span> <span class="n">master</span>
</code></pre>
</div>

<p>一切顺利的话管理仓库应该会被pull下来的
编辑gitosis.conf</p>

<div class="highlight"><pre><code class="ruby"><span class="o">[</span><span class="n">group</span> <span class="n">gitosis</span><span class="o">-</span><span class="n">admin</span><span class="o">]</span>  <span class="c1">#group代表一个组，gitosis-admin为组名</span>
<span class="n">writable</span> <span class="o">=</span> <span class="n">gitosis</span><span class="o">-</span><span class="n">admin</span> <span class="c1">#writable的值为该组的成员可以写的仓库名</span>
<span class="n">members</span> <span class="o">=</span> <span class="n">louis</span><span class="vi">@laptop</span> <span class="c1">#members代表组员，多个组员用空格分割，组员名用username@host的格式</span>
</code></pre>
</div>

<p>该配置的意思就是gitosis-admin这个组中有一个 louis@laptop成员，并且该组的成员对 gitosis-admin这个repo可写
因为这里组名和repo名一样，所以要注意区分，这两个是完全不同的</p>

<p>增加仓库</p>

<p>仓库不用手动创建，只要在配置文档中某成员对某个名称的仓库（该仓库可能还不存在！）可写，那么当该成员向这个远程仓库push的时候，gitosis会自动在/home/git/repositories下创建仓库对应的目录the_repo.git。</p>

<p>增加成员</p>

<p>如上文说的，增加成员直接在members中写出成员名字就行了，然后需要该成员把自己的公钥复制到keydir中，以 成员名.pub 的格式命名。</p>

<p><strong><em>以上这些配置必须要push之后才能生效！</em></strong></p>

<h3>代码自动部署</h3>

<p>这里用一个git的post-update HOOK就能完成</p>

<p>假设现在需要将web仓库提交来的代码自动部署到/var/www/html/目录下</p>

<p>首先需要将/var/www/html加入版本控制，并切将远程仓库设置为 web.git</p>

<div class="highlight"><pre><code class="ruby"><span class="c1">#hooks文件夹下存储了各种钩子的实例文件</span>
<span class="c1">#如果要添加post-update钩子，则将post-update.sample后面的.sample去掉即可，当用户提交后，git会自动在hooks目录下寻找名为post-update的文件，若找到则执行其中代码</span>
<span class="n">cd</span> <span class="sr">/home/</span><span class="n">git</span><span class="o">/</span><span class="n">repositories</span><span class="o">/</span><span class="n">web</span><span class="o">.</span><span class="n">git</span><span class="o">/</span><span class="n">hooks</span>
<span class="c1">#创建post-update文件</span>
<span class="n">touch</span> <span class="n">post</span><span class="o">-</span><span class="n">update</span>
<span class="n">vim</span> <span class="n">post</span><span class="o">-</span><span class="n">update</span>
</code></pre>
</div>

<p>在psot-update中加入以下代码</p>

<div class="highlight"><pre><code class="ruby"><span class="no">DEPLOY_DIR</span><span class="o">=</span><span class="sr">/var/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span>
<span class="n">unset</span> <span class="no">GIT_DIR</span> <span class="c1">#!important 如果不使用这句，是无法改变下面git pull的执行环境的</span>
<span class="n">cd</span> <span class="vg">$DEPLOY_DIR</span>
<span class="n">git</span> <span class="n">pull</span> <span class="n">origin</span> <span class="n">master</span>
</code></pre>
</div>

<p>这样当每次push之后，git都会自动在/var/www/html下自动执行一次git pull origin master，这样就实现了自动部署代码的功能。</p>

<p><strong><em>这里要注意所有文件目录的权限问题，要确保git用户拥有读写权限</em></strong></p>


<div class="previous_next_post">

  
    <p>
      <strong>Previous Entry:</strong>
      <a href="/2013/10/zabbix-works-with-external-scripts/" title="zabbix与外部监控脚本整合方案">zabbix与外部监控脚本整合方案</a>
    </p>
  

  
    <p>
      <strong>Next Entry:</strong>
      <a href="/2013/11/git-quick-start/" title="git quick start">git quick start</a>
    </p>
  
  
  <div style="clear: both;"></div>
  
</div>


		
    <div id="footer">
      Powered by <a href="http://github.com/mojombo/jekyll" title="Jekyll Site Generator">Jekyll</a> 

    </div>
    <script src="/scripts/jquery.js"></script>
    <script>
        var c_popup = $("#c_popup");
        var category_popup = $(".category_popup");
        var category_items = $(".category_item");
        c_popup.mouseover(function(){
            category_popup.show();
        });
        c_popup.mouseout(function(){
            category_popup.hide();
        });
        category_popup.mouseover(function(){
            category_popup.show();
        })
        category_popup.mouseout(function(){
            category_popup.hide();
        });
        $(".category_item").click(function(){
            location.href = $(this).attr("data-href");
        });
    </script>
  </body>
</html>
